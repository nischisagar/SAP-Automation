---
- name: Global read only file system report file creation
  hosts: ampsv010bld0d
  become: yes
  become_method: enable
  gather_facts: false
  tasks:
  - name: Create the global read only file system report file
    copy:
      content: 'Server Name;Source Name;Mount Name;Mount Options'
      dest: "/ansible/reports/ro-fs.xls"
    run_once: yes

- name: Check the read only file systems
  hosts: cn
  become: yes
  become_method: enable
  gather_facts: false
  tasks:
  - name: Run the setup module
    setup:

  - name: Add the entries in local read only file system report file
    lineinfile:
      dest: "/tmp/ro-fs.xls"
      line: "{{ ansible_fqdn }};{{ item.device }};{{ item.mount }};{{ item.options }}"
      create: yes
    loop: "{{ ansible_mounts }}"
    when : "'ro,' in item.options"
    register: ro_fs_exist

  - name: Register the content of /tmp/ro-fs.xls file
    shell: "cat /tmp/ro-fs.xls"
    register: ro_fs_output
    when: ro_fs_exist.changed

  - name: Add the entries in global read only file system report file
    lineinfile:
      dest: "/ansible/reports/ro-fs.xls"
      line: "{{ ro_fs_output.stdout }}"
    delegate_to: ampsv010bld0d
    when: ro_fs_exist.changed

  - name: Clean the local read only file system report report file
    file:
      path: "/tmp/ro-fs.xls"
      state: absent
    when: ro_fs_exist.changed

- name: Send e-mail
  hosts: ampsv010bld0d
  become: yes
  become_method: sudo
  gather_facts: false
  tasks:
    - name: Send e-mail to a bunch of users, attaching files
      mail:
        host: smtp.mail.saint-gobain.net
        port: 25
        subject: Ansible Report - Linux read only file system check 
        body: Hello Team, Please find the attached Linux read only file system check report from Linux servers.
        from: ampsv010bld0d.p1.saint-gobain.net@saint-gobain.com (Ansible Tower)
        to:
        - Poonjolai Govindasamy <pogovind@in.ibm.com>
        cc: 
        - Sureshkumar Krishnamurthy <sureshkk@in.ibm.com>
        attach:
        - "/ansible/reports/ro-fs.xls"
        headers:
        - Reply-To=pogovind@in.ibm.com
        - X-Special="Please contact Poonjolai Govindasamy if any issues are in this report."
        charset: us-ascii
      when: ro_fs_exist.changed
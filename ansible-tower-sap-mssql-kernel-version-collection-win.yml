---
- name: Socks tunnel setup
  hosts: sap_mssql_host_name_single_sid
  gather_facts: no
  roles:
  - role: ansible-role-event-socks-tunnel
    run_once: true
    delegate_to: localhost
    vars:
      acc_id: "sgi"
      transaction_id: "{{ tower_job_id }}"

- name: Create the Global report file
  hosts: sap_mssql_host_name_single_sid
  gather_facts: no
  become: yes
  become_method: runas
  become_user: system
  vars:
    report_file: "c:/temp/sap_msql_version.csv"
  tasks:
    - name: Create the global report file
      win_copy:
        content: 'Entity Name,Host Name,SID,OS Name,OS Version,IP Address,SAP/Java Version,SAP Kernel Base,SAP Kernel Patch Version,DB Name,DB Version'
        dest: "{{ report_file }}"
      run_once: yes
      delegate_to: ampsw046decc0

- name: Get the MS-SQL version from Windows Servers (Single SID)
  hosts: sap_mssql_host_name_single_sid
  become: yes
  become_method: runas
  become_user: system
  vars:
    report_file: "c:/temp/sap_msql_version.csv"
  roles:
  - role: get-the-sap-version-mssql-win
    delegate_to: ampsw046decc0
  tasks:
    - name: Add the temporary localreport file
      win_lineinfile:
        dest: "{{ report_file }}"
        line: "{{ entity_name }},{{ ansible_fqdn }},{{ item.get_sid }},{{ ansible_distribution }},{{ ansible_distribution_version }},{{ansible_default_ipv4.address }},{{ item.get_spv}},{{ item.get_kmv }},{{ item.get_kpn }},{{ item.get_dbn }},{{ item.get_dbv }}"
      throttle: 1
      loop: 
        - get_sid: "{{ item.name[0] }}"
          get_spv: "{{ sap_verison.results[0].stdout }}"
          get_dbn: "{{ db_name.results[0].stdout }}" 
          get_dbv: "{{ db_verison.results[0].stdout }}" 
          get_kmv: "{{ kernal_base_verison.results[0].stdout }}"
          get_kpn: "{{ kernal_patch_verison.results[0].stdout }}"
      delegate_to: ampsw046decc0

- name: Send e-mail
  hosts: ampsw046decc0
  become: yes
  become_method: sudo
  gather_facts: false
  tasks:
    - name: Send e-mail to a bunch of users, attaching files
      mail:
        host: smtp.mail.saint-gobain.net
        port: 25
        subject: Ansible Report - SAP and Ms-SQL versions
        body: Hello Team, Please find the attached SAP and Ms-SQL versions report from Ms-SQL servers.
        from: ampsv010bld0d.p1.saint-gobain.net@saint-gobain.com (Ansible Tower)
        to:
        - Monthly SAP JAVA and DB version Report <Monthly.jg8pdmspxxbg0ywn@u.box.com>
        attach:
        - "{{ report_file }}"
        headers:
        - Reply-To=pogovind@in.ibm.com
        - X-Special="Please contact Poonjolai Govindasamy if any issues are in this report."
        charset: us-ascii

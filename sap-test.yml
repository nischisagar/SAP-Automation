---
- name: Add the title content in to SAP Version Details Report
  hosts: ampsv010bld0d
  become: yes
  become_method: sudo
  tasks:
    - name: Add the title content in to SAP,JAVA,ABAP,DB2 and Oracle DB Version Details Report File
      copy:
        content: 'Entity Name,Host Name,SID,Application Type,SAP/Java Version,SAP Kernel Base,SAP Kernel Patch Version,DB Name,DB Version,DB Size (in GB)'
        dest: "{{ report_file }}"
      run_once: yes

- name: Get MAXDB SCM servers version detail
  hosts: sap_maxdb_content_server_sid2
  become: yes
  become_method: sudo
  vars:
    ansible_python_interpreter: "/usr/bin/python"
    app_type: "SAP-SCM/Content server"
  roles:
  - role: get-the-sap-version-maxdb-contentserver-sid
  tasks:
    - name: Add the server details in to the SAP, DB2, Oracle, HANA and MAX DB Report File.
      lineinfile:
        dest: "{{ report_file }}"
        line: '{{ entity_name }},{{ ansible_nodename.split(".")[0] | lower }},{{ item.get_sid }},{{ app_type }},NA,NA,NA,{{ item.get_dbn }},{{ item.get_dbv }},NA'
      throttle: 1
      loop:
        - get_sid: "{{ get_sid_output.results[0].stdout }}"
          get_dbn: "{{ get_db_name_output.results[0].stdout }}"
          get_dbv: "{{ get_db_version_output.results[0].stdout }}"
        - get_sid: "{{ get_sid_output.results[1].stdout }}"
          get_dbn: "{{ get_db_name_output.results[1].stdout }}"
          get_dbv: "{{ get_db_version_output.results[1].stdout }}"        
      delegate_to: ampsv010bld0d

- name: Send e-mail
  hosts: ampsv010bld0d
  become: yes
  become_method: sudo
  tasks:
    - name: Copy the file with date format
      copy: 
        src: "{{ report_file }}"
        dest: "/ansible/reports/maxdbnew-{{ ansible_date_time.date }}.csv"
        remote_src: yes
    - name: Send e-mail to a bunch of users, attaching files
      mail:
        host: smtp.mail.saint-gobain.net
        port: 25
        subject: Ansible Report - SAP, JAVA, DB2, Oracle, HANA and MAX DB versions
        body: Hello Team, Please find the attached SAP, Java, DB2, Oracle, HANA and Max DB versions report from DB2, Oracle, HANA and MAX DB servers.
        from: ampsv010bld0d.p1.saint-gobain.net@saint-gobain.com (Ansible Tower)
        to:
        - Kalaikannan.Anbarasan@kyndryl.com
        cc: 
        - Kalaikannan.Anbarasan@kyndryl.com       
        attach:
        - "/ansible/reports/maxdbnew-{{ ansible_date_time.date }}.csv"
        headers:
        - Reply-To=Kalaikannan.Anbarasan@kyndryl.com
        - X-Special="Please contact Kalaikannan Anbarasan if any issues are in this report."
        charset: us-ascii
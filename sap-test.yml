---
- name: Get multitenant hana db sap and unix agent status (Two SIDs)
  hosts: sap_hanadb_abap2_host_name_single_sid
  become: yes
  become_method: sudo
  vars: 
    ansible_python_interpreter: "/usr/bin/python"
  roles:
  - role: itm_agent_monitoring_status_abap2_45
    ignore_errors: yes
  tasks:
    - name: HANA CI Servers Agent user status
      lineinfile:
        dest: "{{ report_file2 }}"
        line: '{{ entity_name }},{{ ansible_nodename.split(".")[0] | lower }},{{ item.get_sid }},{{ item.get_sap }}'
      throttle: 1
      loop:
        - get_sid: "{{ get_SID.results[0].stdout }}"
          get_sap: "{{ get_uflag.results[0].stdout }}"
        - get_sid: "{{ get_SID.results[1].stdout }}"
          get_sap: "{{ get_uflag.results[1].stdout }}"
      delegate_to: ampsv010bld0d

- name: Send e-mail
  hosts: ampsv010bld0d
  become: yes
  become_method: sudo
  gather_facts: false
  tasks:
    - name: Send e-mail to a bunch of users, attaching files
      mail:
        host: smtp.mail.saint-gobain.net
        port: 25
        subject: Ansible Report - SAP CRYPTO Version
        body: Hello Team, Please find the attached sap crypto version details for AIX Servers
        from: ampsv010bld0d.p1.saint-gobain.net@saint-gobain.com (Ansible Tower)
        to:
        - Kalaikannan.Anbarasan@kyndryl.com
        cc: 
        - Kalaikannan.Anbarasan@kyndryl.com
        attach:
        - "{{ report_file }}"
        headers:
        - Reply-To=Kalaikannan.Anbarasan@kyndryl.com
        - X-Special="Please contact Kalaikannan Anbarasan if any issues are in this report."
        charset: us-ascii

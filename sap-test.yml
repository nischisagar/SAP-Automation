---
- name: Create the Global report file
  hosts: ampsv010bld0d
  become: yes
  become_method: sudo
  gather_facts: yes
  tasks:
    - name: Create the global report file
      copy:
        content: 'Entity_Name,Host_Name,SID,IBMMON_Agent_uflag,sap_agent_status,ux_sa_status'
        dest: "{{ report_file_maxdb }}"
      run_once: yes

- name: Collect MAXDB Servers IBMMON_AGENT User status
  hosts:  sap_maxdb_abap_host_name_single_sid1_new1
  become: yes
  become_method: sudo
  vars:
    ansible_python_interpreter: "/usr/bin/python"
  roles:
  - role: itm_agent_monitoring_status_maxdb
    ignore_errors: yes
  tasks:
    - name: MAXDB Servers Agent user status
      lineinfile:
        dest: "{{ report_file_maxdb }}"
        line: '{{ entity_name }},{{ ansible_nodename.split(".")[0] | lower }},{{ item.0 }},{{ item.1 }},{{ item.2 }},{{ item.3 }}'
      with_together:
        - "{{ get_sid.stdout_lines }}"
        - "{{ get_uflag.stdout_lines }}"
        - "{{ get_sa.stdout_lines }}"
        - "{{ get_ux.stdout_lines }}"
      delegate_to: ampsv010bld0d
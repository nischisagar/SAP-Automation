---
- name: Getting current host info
  shell: hostname
  register: hname

- debug:
    msg: "{{ hname }}"

- name: Setting facts - hname
  set_fact:
    hname: "{{ hname['stdout'] }}"

- debug:
    msg: "{{ hname }}"

- name: Copy script to /usr/sap/hostctrl/exe/csr_openssl
  copy:
    src: "{{ role_path }}/files/{{ item }}"
    dest: /usr/sap/hostctrl/exe/csr_openssl/
    owner: root
    group: system
    mode: '0775'
  with_items:
  - Saint_Gobain_Root_CA.cer
  - Saint_Gobain_Server_CA.cer
  - SG-RootCA-G2.cer
  - SG-ServersCA-G2.cer
  - "{{ hname }}_csr.txt"

- name: Create PKCS12 file
  shell: |
    cd {{ install_path }};
    signfile=`ls {{ hname }}*`
    echo "signfile = $signfile"
    openssl pkcs12 -export -out certificate.pfx -inkey {{ install_path }}/{{ keyname }} -in {{ install_path }}/$signfile -certfile {{ install_path }}/root_inter.cer
    {{ exe_path }}/sapgenpse import_p12 -r {{ install_path }}/Saint_Gobain_Server_CA.cer -r {{ install_path }}/Saint_Gobain_Root_CA.cer -p {{ install_path }}/SAPSSLS.pse {{ install_path }}/certificate.pfx
  register: move1

- debug:
    msg: "{{ move1 }}"


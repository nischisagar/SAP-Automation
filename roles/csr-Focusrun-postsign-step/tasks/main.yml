---
- name: Getting current host info
  shell: hostname
  register: hname

- debug:
    msg: "{{ hname }}"

- name: Setting facts - hname
  set_fact:
    hname: "{{ hname['stdout'] }}"

- debug:
    msg: "{{ hname }}"

- name: Copy script to /usr/sap/hostctrl/exe/csr_openssl
  copy:
    src: "{{ role_path }}/files/{{ item }}"
    dest: /usr/sap/hostctrl/exe/csr_openssl/
    owner: root
    group: system
    mode: '0775'
  with_items:
  - Saint_Gobain_Root_CA.cer
  - Saint_Gobain_Server_CA.cer
  - SG-RootCA-G2.cer
  - SG-ServersCA-G2.cer
  - "{{ hname }}_net.cer"

- name: Create PKCS12 file
  shell: |
    cd {{ install_path }};
    cat {{ install_path }}/SG-ServersCA-G2.cer {{ install_path }}/SG-RootCA-G2.cer > {{ install_path }}/root_inter.cer
    openssl pkcs12 -export -out {{ install_path }}/certificate.pfx -passout pass:{{ password2 }} -inkey {{ install_path }}/{{ keyname }} -passin pass:{{ password1 }} -in {{ install_path }}/{{ signfile }} -certfile {{ install_path }}/root_inter.cer
    {{ exe_path }}/sapgenpse import_p12 -r {{ install_path }}/SG-ServersCA-G2.cer -r {{ install_path }}/SG-RootCA-G2.cer -p {{ install_path }}/SAPSSLS.pse -x {{ password2 }} -z {{ password2 }} {{ install_path }}/certificate.pfx
  register: pkcsout

- debug:
    msg: "{{ pkcsout }}"



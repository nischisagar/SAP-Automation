---
- name: Collect SAP CRYPTO Version
  block:
    - name: Get the SID
      win_shell: |
        $Service=get-wmiobject win32_service |?{$_.Name -like '*SAP???_??*' -and $_.pathname -match 'D00|DVE|SCS' -and $_.state -eq "Running"}
        $sub_service=(($service.Name).Substring(3)).split("_")
        $sub_service[0].ToLower() > K:\version\sidlist.txt
        $sub_service[2].ToLower() >> K:\version\sidlist.txt
        $sub_service[4].ToLower() >> K:\version\sidlist.txt
        $sub_service[6].ToLower() >> K:\version\sidlist.txt
        Get-Content K:\version\sidlist.txt | Get-Unique | Set-Content K:\version\sidlist_final.txt        
      register: sid
      ignore_errors: true

    - name: collect sid output
      win_shell: |
        cat K:\version\sidlist_final.txt        
      register: sid_list

    - debug:
        msg: "{{ item }}"
      with_items: "{{ sid_list['stdout_lines'] }}"

    - name: Get the SAP version
      win_shell: |
        hostname > K:\version\testoutput_{{ item[0] }}.txt
      become: yes
      become_method: runas
      become_user: "{{ item[0] | lower }}adm"
      loop: "{{ sid_list['stdout_lines'] }}"
      register: sap_hostname

    - name: hostname output
      debug:
        msg: "{{ sap_hostname }}"


      

    

